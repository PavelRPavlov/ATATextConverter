@page "/converter"
@attribute [Authorize]

@using ATAFurniture.Server.Models
@using ATAFurniture.Server.DataAccess
@using ATAFurniture.Server.Components.FileDisplay

<RadzenStack Gap="1em">
    <TargetCompanySelectionComponent Context="@Context"/>
    @if (Context.TargetCompany != null)
    {
        <UserCreditsComponent />
        
        <FileUploadComponent Context="@Context"/>
        
        <FileDisplayComponent Context="@Context"/>
        
        <OrderHandlingComponent Context="@Context"/>
    }
</RadzenStack>

@code {
    [Inject] UserContextService UserContextService { get; set; }
    private ConverterContext Context { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (UserContextService.User is null)
        {
            await UserContextService.ExtractUserIdentity();
        }
        var lastSelection = UserContextService.User!.LastSelectedCompany;
        Context.TargetCompany = lastSelection ?? await UserContextService.GetPreviouslySelectedTargetCompanyAsync();
        
        Context.ContactInfo.CompanyName = UserContextService.User.CompanyName;
        Context.ContactInfo.MobileNumber = UserContextService.User.MobileNumber;
    }
}